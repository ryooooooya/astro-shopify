---
import { getProductByHandle } from "./../../utils/shopify";
import { setCache } from "../../utils/cache";

import BaseLayout from "../../layouts/BaseLayout.astro";
import NotFoundLayout from "../../layouts/NotFoundLayout.astro";

import AddToCartForm from "../../components/AddToCartForm.svelte";
import ProductImageGallery from "../../components/ProductImageGallery.astro";
import ProductCardByMicrocms from "../../components/ProductCardByMicrocms.astro";
import Money from "../../components/Money.svelte";
import ProductListXScrollWrap from "../../components/ProductListXScrollWrap.astro";

const { handle } = Astro.params;
const headers = Astro.request.headers;
const ip = headers.get("x-vercel-forwarded-for") || Astro.clientAddress;
const product = await getProductByHandle({ handle: handle || "", buyerIP: ip });

if (!product) {
  Astro.response.status = 404;
}

const firstVariant = product?.variants.nodes[0];
setCache.short(Astro);

import { getProductDetail, getProducts } from "../../utils/microcms";
import { getProductsByHandles } from "./../../utils/shopify";

// Get product information with depth 1 (only direct relations)
const productInfomation = await getProductDetail(handle as string, {
  depth: 1
});

// Build filters for related products
const seriesIds = productInfomation.series.map((s) => s.id);
const designerIds = productInfomation.designers.map((d) => d.id);
const categoryIds = productInfomation.categories.map((c) => c.id);

// Fetch related products with optimized queries (only what's needed for each section)
const [seriesProducts, designerProducts, categoryProducts] = await Promise.all([
  // Only fetch if there are series
  seriesIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${productInfomation.id}[and]series[contains]${seriesIds[0]}${seriesIds.slice(1).map(id => `[or]series[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] }),
  // Only fetch if there are designers
  designerIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${productInfomation.id}[and]designers[contains]${designerIds[0]}${designerIds.slice(1).map(id => `[or]designers[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] }),
  // Only fetch if there are categories
  categoryIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${productInfomation.id}[and]categories[contains]${categoryIds[0]}${categoryIds.slice(1).map(id => `[or]categories[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] })
]);

// Map products to their respective categories
const productsListSeries = productInfomation.series.map((series) => (
  seriesProducts.contents.filter((product: any) =>
    product.series.some((ser: any) => ser.id === series.id)
  )
));
const productsListDesigner = productInfomation.designers.map((designer) => (
  designerProducts.contents.filter((product: any) =>
    product.designers.some((creator: any) => creator.id === designer.id)
  )
));
const productsListCat = productInfomation.categories.map((category) => (
  categoryProducts.contents.filter((product: any) =>
    product.categories.some((cat: any) => cat.id === category.id)
  )
));

// Collect all unique product IDs and fetch Shopify products in bulk
const allProductIds = new Set([
  ...seriesProducts.contents.map((p: any) => p.id),
  ...designerProducts.contents.map((p: any) => p.id),
  ...categoryProducts.contents.map((p: any) => p.id)
]);
const shopifyProductsMap = await getProductsByHandles({
  handles: Array.from(allProductIds),
  buyerIP: ip
});
---

{
  !product ? (
    // 取得できなかったとき
    <NotFoundLayout title="Product not found" message="Product not found" />
  ) : (
    // 取得できたとき
    <BaseLayout title={product.title}>
      <section class="pt-20 pb-8">
        <div class="grid grid-cols-2 gap-12 max-xs:grid-cols-1">
          <div class="">
            <ProductImageGallery images={product.images} />
          </div>
          <div class="pt-6">
            <h1 class="text-2xl">
              {productInfomation.name}
            </h1>
            <p class="mt-6 text-[28px] leading-6">
              <Money price={product?.variants.nodes[0].price} size="lg" />
              <span class="text-base"> （税込）</span>
            </p>
            <div class="max-w-[200px] mt-5 max-xs:max-w-full">
              <AddToCartForm
                client:load
                variantId={firstVariant?.id}
                variantQuantityAvailable={firstVariant?.quantityAvailable}
                variantAvailableForSale={firstVariant?.availableForSale}
              />
            </div>
            <dl class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-5 mt-12">
              <dd class="text-xs -mt-1 text-right">
                Designer:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {productInfomation.designers.map((designer) => (
                  <a href={`/designers/${designer.id}`}>{designer.nameJa}</a>
                ))}
              </dt>
              <dd class="text-xs -mt-1 text-right">
                Size:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {productInfomation.size}
              </dt>
              <dd class="text-xs -mt-1 text-right">
                Series:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {productInfomation.series.map((series) => (
                  <a href={`/series/${series.id}`}>{series.title}</a>
                ))}
              </dt>
              {productInfomation.text && (
                <>
                  {productInfomation.text.map((contents) => (
                    <>
                      <dd class="text-xs -mt-1 text-right">
                        {contents.title}:
                      </dd>
                      <dt class="text-xl">
                        <div set:html={contents.description} />
                      </dt>
                    </>
                  ))}
                </>
              )}
              <dd class="text-xs -mt-1 text-right">
                Notes:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {productInfomation.link.map((note) =>(
                  <a href={note.url} target="_blank" rel="noopener noreferrer">{note.text}</a>
                ))}
              </dt>
            </dl>
          </div>
        </div>
      </section>
      {productInfomation.series && productInfomation.series.length > 0 && productInfomation.series.map((series: any, index: number) =>(
        productsListSeries[index] && productsListSeries[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Series :</span>
              <span class="text-2xl">{series.title}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListSeries[index].map((product: any) => (
                <ProductCardByMicrocms
                  product={product}
                  productShopify={shopifyProductsMap.get(product.id)}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      {productInfomation.designers && productInfomation.designers.length > 0 && productInfomation.designers.map((designer: any, index: number) =>(
        productsListDesigner[index] && productsListDesigner[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Designer :</span>
              <span class="text-2xl">{designer.nameJa}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListDesigner[index].map((product: any) => (
                <ProductCardByMicrocms
                  product={product}
                  productShopify={shopifyProductsMap.get(product.id)}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      {productInfomation.categories && productInfomation.categories.length > 0 && productInfomation.categories.map((category: any, index: number) => (
        productsListCat[index] && productsListCat[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Category :</span>
              <span class="text-2xl">{category.name}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListCat[index].map((product: any) => (
                <ProductCardByMicrocms
                  product={product}
                  productShopify={shopifyProductsMap.get(product.id)}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      <div class="mt-20">
        <a href="/" class="text-underline text-2xl hover:no-underline">
          Back
        </a>
      </div>
    </BaseLayout>
  )
}
