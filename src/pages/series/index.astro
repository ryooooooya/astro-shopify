---
import { getSeries, getProducts } from "../../utils/microcms";
import { getProductsByHandles } from "../../utils/shopify";
import { setCache } from "../../utils/cache";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProductCardByMicrocms from "../../components/ProductCardByMicrocms.astro";
import ProductListXScrollWrap from "../../components/ProductListXScrollWrap.astro";

const title = "Astro + Shopify";

const series = await getSeries({
  limit: 100
});
const products = await getProducts({
  limit: 4
});

// Fetch Shopify products in bulk
const headers = Astro.request.headers;
const ip = headers.get("x-vercel-forwarded-for") || Astro.clientAddress;
const handles = products.contents.map((p: any) => p.id);
const shopifyProductsMap = await getProductsByHandles({ handles, buyerIP: ip });

// Apply static cache for series list page
setCache.static(Astro);
---

<BaseLayout title={title} currentPage="series">
  <section class="h-full pt-10 pb-12 max-sm:pt-16">
    <h2 class="text-xs">
      All series:
    </h2>
    <div class="flex flex-col gap-y-16 mt-3 max-md:gap-y-12 max-sm:gap-y-8">
      {series.contents.map((content: any) => (
        <ProductListXScrollWrap>
          <a href={`/series/${content.id}`} class="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]">
            <h3 class="text-xl text-underline hover:no-underline whitespace-normal">
              {content.title}
            </h3>
            <p class="mt-2 text-base line-clamp-5 whitespace-normal">
              {content.text}
            </p>
          </a>
          <>
            {products.contents.map((product: any) => (
              <>
                {product.series.map((ser: any) => (
                  ser.id === content.id && (
                    <ProductCardByMicrocms
                      product={product}
                      productShopify={shopifyProductsMap.get(product.id)}
                      className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                      noSeries
                    />
                  )
                ))}
              </>
            ))}
          </>
        </ProductListXScrollWrap>
      ))}
    </div>
  </section>
</BaseLayout>